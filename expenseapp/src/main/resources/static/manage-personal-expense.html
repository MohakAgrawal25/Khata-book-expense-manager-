<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Personal Expenses - Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Base Styles - Match Other Pages */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
            position: relative;
            padding: 0;
        }

        /* Animated background elements */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(5, 150, 105, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(52, 211, 153, 0.2) 0%, transparent 50%);
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg) scale(1); 
            }
            33% { 
                transform: translateY(-15px) rotate(0.5deg) scale(1.02); 
            }
            66% { 
                transform: translateY(10px) rotate(-0.5deg) scale(0.98); 
            }
        }

        /* Floating particles */
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            animation: floatParticle 20s infinite linear;
            backdrop-filter: blur(5px);
        }

        .particle:nth-child(1) {
            width: 60px;
            height: 60px;
            top: 15%;
            left: 15%;
            animation-delay: 0s;
            background: rgba(255, 255, 255, 0.2);
        }

        .particle:nth-child(2) {
            width: 100px;
            height: 100px;
            top: 65%;
            right: 15%;
            animation-delay: -7s;
            background: rgba(255, 255, 255, 0.1);
        }

        .particle:nth-child(3) {
            width: 80px;
            height: 80px;
            bottom: 25%;
            left: 25%;
            animation-delay: -14s;
            background: rgba(255, 255, 255, 0.15);
        }

        @keyframes floatParticle {
            0% { 
                transform: translate(0, 0) rotate(0deg) scale(1); 
            }
            25% { 
                transform: translate(30px, -40px) rotate(90deg) scale(1.1); 
            }
            50% { 
                transform: translate(60px, 20px) rotate(180deg) scale(0.9); 
            }
            75% { 
                transform: translate(20px, 50px) rotate(270deg) scale(1.05); 
            }
            100% { 
                transform: translate(0, 0) rotate(360deg) scale(1); 
            }
        }

        /* Main container */
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        /* Navigation - Match Other Pages */
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            padding: 1rem 0 !important;
            position: relative;
            z-index: 1000;
        }

        .navbar .container {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            flex-wrap: nowrap !important;
        }

        .navbar-brand {
            font-weight: 700;
            color: #059669 !important;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            margin: 0 !important;
        }

        .navbar-nav {
            display: flex !important;
            align-items: center !important;
            margin: 0 !important;
            padding: 0 !important;
            flex-wrap: nowrap;
        }

        .nav-link {
            color: #374151 !important;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem !important;
            white-space: nowrap;
            margin: 0 !important;
        }

        .nav-link:hover {
            color: #059669 !important;
            transform: translateY(-1px);
        }

        .nav-link.active {
            color: #059669 !important;
            font-weight: 600;
        }

        /* Main content wrapper */
        .main-content {
            padding: 2rem 1rem;
            position: relative;
            z-index: 2;
        }

        /* Cards - Match Other Pages */
        .stats-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border: none !important;
            border-radius: 20px !important;
            box-shadow: 
                0 8px 20px rgba(5, 150, 105, 0.2),
                0 2px 4px rgba(5, 150, 105, 0.1) !important;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
            color: #374151;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .stats-card:hover {
            transform: translateY(-8px) !important;
            box-shadow: 
                0 25px 50px rgba(5, 150, 105, 0.3),
                0 4px 8px rgba(5, 150, 105, 0.2) !important;
        }

        .stats-card .card-title {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stats-card h3 {
            color: #059669;
            font-weight: 800;
            font-size: 2rem;
            margin: 0;
        }

        .stats-card .fas {
            color: #059669;
            opacity: 0.8;
        }

        .group-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border: none !important;
            border-radius: 20px !important;
            box-shadow: 
                0 8px 20px rgba(5, 150, 105, 0.2),
                0 2px 4px rgba(5, 150, 105, 0.1) !important;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
            cursor: pointer;
            border-left: 4px solid #10b981 !important;
            position: relative;
            overflow: hidden;
        }

        .group-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .group-card:hover {
            transform: translateY(-8px) translateX(5px) !important;
            box-shadow: 
                0 25px 50px rgba(5, 150, 105, 0.3),
                0 4px 8px rgba(5, 150, 105, 0.2) !important;
            border-left-color: #059669 !important;
        }

        .empty-state {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 3rem 2rem;
            text-align: center;
            border: 2px dashed #d1d5db;
        }

        .empty-state .fas {
            font-size: 4rem;
            color: #9ca3af;
            margin-bottom: 1.5rem;
        }

        .empty-state h4 {
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        /* Header Section */
        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #020605;
            margin-bottom: 0.5rem;
        }

        .text-muted {
            color: #000205 !important;
            font-size: 1.1rem;
        }

        /* Search Box */
        .search-box .form-control {
            padding: 0.875rem 1rem !important;
            border: 2px solid #e5e7eb !important;
            border-radius: 10px !important;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .search-box .form-control:focus {
            outline: none !important;
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
            background: rgba(255, 255, 255, 1);
        }

        /* Buttons - Match Other Pages */
        .btn {
            cursor: pointer !important;
            user-select: none;
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            outline: none;
            font-weight: 600;
            border-radius: 15px !important;
            box-shadow: 
                0 8px 20px rgba(5, 150, 105, 0.2),
                0 2px 4px rgba(5, 150, 105, 0.1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: auto;
            text-decoration: none !important;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 
                0 15px 30px rgba(5, 150, 105, 0.3),
                0 4px 8px rgba(5, 150, 105, 0.2) !important;
            text-decoration: none !important;
        }

        .btn:active {
            transform: translateY(-1px) !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
            border: 2px solid transparent !important;
            padding: 0.875rem 1.5rem !important;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #059669, #047857) !important;
            box-shadow: 
                0 15px 30px rgba(5, 150, 105, 0.4),
                0 4px 8px rgba(5, 150, 105, 0.3) !important;
        }

        .btn-outline-primary {
            background: transparent !important;
            color: #059669 !important;
            border: 2px solid #059669 !important;
        }

        .btn-outline-primary:hover {
            background: #059669 !important;
            color: white !important;
        }

        .btn-light {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0) !important;
            color: #475569 !important;
            border: 2px solid #e2e8f0 !important;
        }

        .btn-light:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1) !important;
            color: #374151 !important;
        }

        /* Badges */
        .badge-custom {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
        }

        .bg-primary {
            background: linear-gradient(135deg, #10b981, #059669) !important;
        }

        .bg-info {
            background: linear-gradient(135deg, #0ea5e9, #0284c7) !important;
        }

        .bg-success {
            background: linear-gradient(135deg, #22c55e, #16a34a) !important;
        }

        .bg-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }

        /* IMPROVED FORM SELECT - Fixed multiple arrows */
        .form-select {
            padding: 0.875rem 2.5rem 0.875rem 1rem !important;
            border: 2px solid #e5e7eb !important;
            border-radius: 10px !important;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            /* Custom dropdown arrow - only one */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23059669' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 1rem center !important;
            background-size: 16px 12px !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none !important;
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
            background-color: rgba(255, 255, 255, 1) !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23059669' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
        }

        /* Custom select wrapper */
        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            display: none !important; /* Hide Bootstrap's default arrow */
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(16, 185, 129, 0.2) !important;
            border-top: 4px solid #10b981 !important;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert */
        .alert {
            border-radius: 12px !important;
            border: 1px solid transparent !important;
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1) !important;
            color: #065f46 !important;
            border-color: rgba(16, 185, 129, 0.2) !important;
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1) !important;
            color: #991b1b !important;
            border-color: rgba(239, 68, 68, 0.2) !important;
        }

        /* Card Header */
        .card-header {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
            padding: 1.5rem 2rem !important;
            border: none !important;
            border-radius: 20px 20px 0 0 !important;
        }

        .card-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Glow effect */
        .glow {
            position: absolute;
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(5, 150, 105, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(50px);
            z-index: 1;
            animation: glowMove 10s ease-in-out infinite;
        }

        .glow:nth-child(1) {
            top: -80px;
            left: -80px;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.4) 0%, transparent 70%);
        }

        .glow:nth-child(2) {
            bottom: -80px;
            right: -80px;
            animation-delay: -5s;
            background: radial-gradient(circle, rgba(52, 211, 153, 0.3) 0%, transparent 70%);
        }

        @keyframes glowMove {
            0%, 100% { 
                transform: translate(0, 0) scale(1) rotate(0deg); 
            }
            33% { 
                transform: translate(30px, 30px) scale(1.1) rotate(120deg); 
            }
            66% { 
                transform: translate(-20px, 40px) scale(0.9) rotate(240deg); 
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .container {
                max-width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .stats-card h3 {
                font-size: 1.5rem;
            }
            
            .stats-card .fas {
                font-size: 1.5rem;
            }
            
            .search-box {
                max-width: 100% !important;
            }
            
            .group-card .row > div {
                margin-bottom: 1rem;
            }
            
            .group-card .text-end {
                text-align: left !important;
            }
            
            .navbar-brand {
                font-size: 1.25rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.75rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .form-select {
                padding: 0.75rem 2rem 0.75rem 0.75rem !important;
                background-position: right 0.75rem center !important;
            }
        }

        /* Text selection styles */
        ::selection {
            background: rgba(16, 185, 129, 0.3);
            color: #1f2937;
        }

        ::-moz-selection {
            background: rgba(16, 185, 129, 0.3);
            color: #1f2937;
        }

        /* Dropdown options styling */
        .form-select option {
            padding: 10px 15px;
            font-size: 1rem;
            background: white;
            color: #374151;
        }

        .form-select option:hover {
            background: #f0fdf4;
        }

        .form-select option:checked {
            background: #10b981;
            color: white;
        }

        /* Custom select with icon */
        .select-with-icon {
            position: relative;
        }

        .select-with-icon .fas {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #059669;
            pointer-events: none;
            z-index: 2;
        }
    </style>
</head>
<body>
    <!-- Add floating particles -->
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>

    <!-- Add glow effects -->
    <div class="glow"></div>
    <div class="glow"></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-money-bill-wave"></i> Expense Tracker
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/homepage.html">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="nav-link" href="/personal-expenses.html">
                    <i class="fas fa-wallet"></i> Personal Expenses
                </a>
                <a class="nav-link active" href="/manage-personal-expense.html">
                    <i class="fas fa-cog"></i> Manage Expenses
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Header Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1><i class="fas fa-cogs text-primary"></i> Manage Personal Expenses</h1>
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <p class="text-muted">View and manage all your personal expense groups</p>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stats-card text-white card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Groups</h6>
                                    <h3 id="totalGroups">0</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-folder fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card text-white card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Expenses</h6>
                                    <h3 id="totalExpenses">0</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-receipt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card text-white card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Spent</h6>
                                    <h3 id="totalSpent">₹0.00</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card text-white card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Saved</h6>
                                    <h3 id="totalSaved">₹0.00</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-piggy-bank fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card group-card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8 mb-3 mb-md-0">
                                    <div class="input-group search-box">
                                        <input type="text" class="form-control" placeholder="Search expense groups..." id="searchInput">
                                        <button class="btn btn-outline-primary" type="button" onclick="searchGroups()">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="select-wrapper">
                                        <select class="form-select" id="sortSelect" onchange="sortGroups()">
                                            <option value="newest">Newest First</option>
                                            <option value="oldest">Oldest First</option>
                                            <option value="title">Title A-Z</option>
                                            <option value="title-desc">Title Z-A</option>
                                            <option value="expenses">Most Expenses</option>
                                            <option value="expenses-asc">Least Expenses</option>
                                            <option value="spent">Most Spent</option>
                                            <option value="spent-asc">Least Spent</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Groups List Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card group-card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-folder"></i> Your Expense Groups</h5>
                        </div>
                        <div class="card-body">
                            <div id="groupsList">
                                <!-- Groups will be loaded here -->
                                <div class="text-center py-5 empty-state">
                                    <i class="fas fa-folder-open fa-4x mb-3"></i>
                                    <h4>No Expense Groups Found</h4>
                                    <p class="mb-3">You haven't created any expense groups yet.</p>
                                    <a href="personal-expenses.html" class="btn btn-light">
                                        <i class="fas fa-plus-circle me-2"></i>Create Your First Group
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
        <div class="loading-spinner" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // Global variables
        let allGroups = [];
        let filteredGroups = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthAndLoadData();
        });

        // --- AUTHENTICATION FUNCTIONS ---
        function decodeJwtToken(token) {
            if (!token) return null;
            try {
                const payload = token.split('.')[1];
                const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
                return JSON.parse(decoded);
            } catch {
                return null;
            }
        }

        function isTokenExpired(token) {
            try {
                const payload = decodeJwtToken(token);
                if (!payload || !payload.exp) return true;

                const expiry = payload.exp * 1000;
                const now = Date.now();
                return now >= expiry;
            } catch {
                return true;
            }
        }

        function checkAuthAndRedirect() {
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                console.log("No JWT token found. Redirecting to login...");
                window.location.href = 'login.html';
                return false;
            }

            if (isTokenExpired(token)) {
                console.log("JWT token expired. Redirecting to login...");
                localStorage.removeItem('jwtToken');
                window.location.href = 'login.html';
                return false;
            }

            return true;
        }

        // --- ENCODING/DECODING FUNCTIONS ---
        function encodeGroupId(groupId) {
            // Simple base64 encoding to hide the group ID
            return btoa(groupId.toString()).replace(/=/g, '');
        }

        // --- DATA LOADING FUNCTIONS ---
        async function checkAuthAndLoadData() {
            if (!checkAuthAndRedirect()) {
                return;
            }

            showLoading(true);
            try {
                await loadGroups();
                await calculateStatistics();
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Failed to load data. Please try again.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function loadGroups() {
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await axios.get('/api/expense-groups', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Handle both direct data and ApiResponse format
                allGroups = response.data.data || response.data || [];
                filteredGroups = [...allGroups];
                displayGroups(filteredGroups);
                
                console.log('Loaded groups:', allGroups);
                
            } catch (error) {
                console.error('Error loading groups:', error);
                showAlert('Failed to load expense groups.', 'danger');
            }
        }

        // --- STATISTICS CALCULATION ---
        async function calculateStatistics() {
            try {
                // Calculate statistics from loaded groups
                const totalGroups = allGroups.length;
                
                // Calculate total expenses, spent, and saved across all groups
                let totalExpenses = 0;
                let totalSpent = 0;
                let totalSaved = 0;
                
                allGroups.forEach(group => {
                    totalExpenses += group.expenseCount || 0;
                    totalSpent += group.totalSpentInGroup || 0;
                    totalSaved += group.totalSavedInGroup || 0;
                });
                
                // If no groups data, try to load individual expenses
                if (totalExpenses === 0) {
                    await loadIndividualExpensesStatistics();
                    return;
                }
                
                // Update UI with calculated statistics
                updateStatisticsUI(totalGroups, totalExpenses, totalSpent, totalSaved);
                
            } catch (error) {
                console.error('Error calculating statistics:', error);
                // Fallback to individual expenses loading
                await loadIndividualExpensesStatistics();
            }
        }

        async function loadIndividualExpensesStatistics() {
            try {
                const token = localStorage.getItem('jwtToken');
                
                // Load all expenses to calculate totals
                const expensesResponse = await axios.get('/api/expenses', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const expenses = expensesResponse.data.data || expensesResponse.data || [];
                const totalGroups = allGroups.length;
                const totalExpenses = expenses.length;
                
                // Calculate total spent and saved from individual expenses
                let totalSpent = 0;
                let totalSaved = 0;
                
                expenses.forEach(expense => {
                    totalSpent += expense.totalSpent || 0;
                    totalSaved += expense.amountSaved || 0;
                });
                
                updateStatisticsUI(totalGroups, totalExpenses, totalSpent, totalSaved);
                
            } catch (error) {
                console.error('Error loading individual expenses statistics:', error);
                // Final fallback - use groups data only
                const totalGroups = allGroups.length;
                let totalExpenses = 0;
                let totalSpent = 0;
                let totalSaved = 0;
                
                allGroups.forEach(group => {
                    totalExpenses += group.expenseCount || 0;
                    totalSpent += group.totalSpentInGroup || 0;
                    totalSaved += group.totalSavedInGroup || 0;
                });
                
                updateStatisticsUI(totalGroups, totalExpenses, totalSpent, totalSaved);
            }
        }

        function updateStatisticsUI(totalGroups, totalExpenses, totalSpent, totalSaved) {
            document.getElementById('totalGroups').textContent = totalGroups;
            document.getElementById('totalExpenses').textContent = totalExpenses;
            document.getElementById('totalSpent').textContent = '₹' + totalSpent.toFixed(2);
            document.getElementById('totalSaved').textContent = '₹' + totalSaved.toFixed(2);
            
            console.log('Statistics updated:', {
                totalGroups,
                totalExpenses, 
                totalSpent,
                totalSaved
            });
        }

        // --- DISPLAY FUNCTIONS ---
        function displayGroups(groups) {
            const container = document.getElementById('groupsList');
            
            if (groups.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 empty-state">
                        <i class="fas fa-folder-open fa-4x mb-3"></i>
                        <h4>No Expense Groups Found</h4>
                        <p class="mb-3">No groups match your search criteria.</p>
                        <button class="btn btn-light" onclick="clearSearch()">
                            <i class="fas fa-times me-2"></i>Clear Search
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = groups.map(group => `
                <div class="card mb-3 group-card" onclick="viewGroupDetails(${group.id})">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="card-title text-primary mb-2">
                                    <i class="fas fa-folder me-2"></i>${group.title}
                                </h5>
                                <p class="card-text text-muted mb-2">${group.description || 'No description provided'}</p>
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge bg-primary badge-custom">
                                        <i class="fas fa-calendar me-1"></i>
                                        ${formatDate(group.fromDate)} - ${formatDate(group.toDate)}
                                    </span>
                                    <span class="badge bg-info badge-custom">
                                        <i class="fas fa-receipt me-1"></i>
                                        ${group.expenseCount || 0} expenses
                                    </span>
                                    <span class="badge bg-success badge-custom">
                                        <i class="fas fa-money-bill me-1"></i>
                                        ₹${(group.totalSpentInGroup || 0).toFixed(2)}
                                    </span>
                                    ${group.totalSavedInGroup ? `
                                    <span class="badge bg-warning badge-custom">
                                        <i class="fas fa-piggy-bank me-1"></i>
                                        ₹${(group.totalSavedInGroup || 0).toFixed(2)} saved
                                    </span>
                                    ` : ''}
                                </div>
                                <small class="text-muted">
                                    Created: ${formatDate(group.createdAt)}
                                    ${group.updatedAt ? ` • Updated: ${formatDate(group.updatedAt)}` : ''}
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); viewGroupDetails(${group.id})">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="event.stopPropagation(); editGroup(${group.id})">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteGroup(${group.id})">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- UTILITY FUNCTIONS ---
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type) {
            // Remove any existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // --- SEARCH AND SORT FUNCTIONS ---
        function searchGroups() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!query) {
                filteredGroups = [...allGroups];
            } else {
                filteredGroups = allGroups.filter(group => 
                    group.title.toLowerCase().includes(query) ||
                    (group.description && group.description.toLowerCase().includes(query))
                );
            }
            
            sortGroups();
        }

        function sortGroups() {
            const sortBy = document.getElementById('sortSelect').value;
            
            switch (sortBy) {
                case 'newest':
                    filteredGroups.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'oldest':
                    filteredGroups.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'title':
                    filteredGroups.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'title-desc':
                    filteredGroups.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case 'expenses':
                    filteredGroups.sort((a, b) => (b.expenseCount || 0) - (a.expenseCount || 0));
                    break;
                case 'expenses-asc':
                    filteredGroups.sort((a, b) => (a.expenseCount || 0) - (b.expenseCount || 0));
                    break;
                case 'spent':
                    filteredGroups.sort((a, b) => (b.totalSpentInGroup || 0) - (a.totalSpentInGroup || 0));
                    break;
                case 'spent-asc':
                    filteredGroups.sort((a, b) => (a.totalSpentInGroup || 0) - (b.totalSpentInGroup || 0));
                    break;
            }
            
            displayGroups(filteredGroups);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortSelect').value = 'newest';
            filteredGroups = [...allGroups];
            displayGroups(filteredGroups);
        }

        function refreshData() {
            checkAuthAndLoadData();
            showAlert('Data refreshed successfully!', 'success');
        }

        // --- GROUP ACTION FUNCTIONS ---
        function viewGroupDetails(groupId) {
            // Encode the group ID and navigate to group details page
            const encodedId = encodeGroupId(groupId);
            window.location.href = `personal-grp-detail.html?id=${encodedId}`;
        }

        function editGroup(groupId) {
            // Encode the group ID and navigate to edit group page
            const encodedId = encodeGroupId(groupId);
            window.location.href = `personal-grp-detail.html?id=${encodedId}`;
        }

        async function deleteGroup(groupId) {
            if (!confirm('Are you sure you want to delete this expense group? All expenses in this group will be ungrouped.')) {
                return;
            }

            try {
                showLoading(true);
                const token = localStorage.getItem('jwtToken');
                await axios.delete(`/api/expense-groups/${groupId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                showAlert('Expense group deleted successfully!', 'success');
                await checkAuthAndLoadData();
            } catch (error) {
                console.error('Error deleting group:', error);
                showAlert('Failed to delete expense group.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Add enter key support for search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchGroups();
            }
        });
    </script>
</body>
</html>