<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Expenses - Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Base Styles - Match Other Pages */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
            position: relative;
            padding: 0;
        }

        /* Animated background elements */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(5, 150, 105, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(52, 211, 153, 0.2) 0%, transparent 50%);
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg) scale(1); 
            }
            33% { 
                transform: translateY(-15px) rotate(0.5deg) scale(1.02); 
            }
            66% { 
                transform: translateY(10px) rotate(-0.5deg) scale(0.98); 
            }
        }

        /* Floating particles */
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            animation: floatParticle 20s infinite linear;
            backdrop-filter: blur(5px);
        }

        .particle:nth-child(1) {
            width: 60px;
            height: 60px;
            top: 15%;
            left: 15%;
            animation-delay: 0s;
            background: rgba(255, 255, 255, 0.2);
        }

        .particle:nth-child(2) {
            width: 100px;
            height: 100px;
            top: 65%;
            right: 15%;
            animation-delay: -7s;
            background: rgba(255, 255, 255, 0.1);
        }

        .particle:nth-child(3) {
            width: 80px;
            height: 80px;
            bottom: 25%;
            left: 25%;
            animation-delay: -14s;
            background: rgba(255, 255, 255, 0.15);
        }

        @keyframes floatParticle {
            0% { 
                transform: translate(0, 0) rotate(0deg) scale(1); 
            }
            25% { 
                transform: translate(30px, -40px) rotate(90deg) scale(1.1); 
            }
            50% { 
                transform: translate(60px, 20px) rotate(180deg) scale(0.9); 
            }
            75% { 
                transform: translate(20px, 50px) rotate(270deg) scale(1.05); 
            }
            100% { 
                transform: translate(0, 0) rotate(360deg) scale(1); 
            }
        }

        /* Main container */
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        /* Navigation - Match Other Pages */
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            padding: 1rem 0 !important;
            position: relative;
            z-index: 1000;
        }

        .navbar .container {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            flex-wrap: nowrap !important;
        }

        .navbar-brand {
            font-weight: 700;
            color: #059669 !important;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            margin: 0 !important;
        }

        .navbar-nav {
            display: flex !important;
            align-items: center !important;
            margin: 0 !important;
            padding: 0 !important;
            flex-wrap: nowrap;
        }

        .nav-link {
            color: #374151 !important;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem !important;
            white-space: nowrap;
            margin: 0 !important;
        }

        .nav-link:hover {
            color: #059669 !important;
            transform: translateY(-1px);
        }

        .nav-link.active {
            color: #059669 !important;
            font-weight: 600;
        }

        /* Main content wrapper */
        .main-content {
            padding: 2rem 1rem;
            position: relative;
            z-index: 2;
        }

        /* Cards - Match Other Pages */
        .stats-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border: none !important;
            border-radius: 20px !important;
            box-shadow: 
                0 8px 20px rgba(5, 150, 105, 0.2),
                0 2px 4px rgba(5, 150, 105, 0.1) !important;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
            color: #374151;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .stats-card:hover {
            transform: translateY(-8px) !important;
            box-shadow: 
                0 25px 50px rgba(5, 150, 105, 0.3),
                0 4px 8px rgba(5, 150, 105, 0.2) !important;
        }

        .stats-card .card-title {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stats-card h3 {
            color: #059669;
            font-weight: 800;
            font-size: 2rem;
            margin: 0;
        }

        .stats-card .fas {
            color: #059669;
            opacity: 0.8;
        }

        /* Group Cards */
        .group-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border: none !important;
            border-radius: 20px !important;
            box-shadow: 
                0 8px 20px rgba(5, 150, 105, 0.2),
                0 2px 4px rgba(5, 150, 105, 0.1) !important;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
            cursor: pointer;
            border-left: 4px solid #10b981 !important;
            position: relative;
            overflow: hidden;
        }

        .group-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .group-card:hover {
            transform: translateY(-8px) translateX(5px) !important;
            box-shadow: 
                0 25px 50px rgba(5, 150, 105, 0.3),
                0 4px 8px rgba(5, 150, 105, 0.2) !important;
            border-left-color: #059669 !important;
        }

        /* Chart Cards */
        .chart-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border: none !important;
            border-radius: 20px !important;
            box-shadow: 
                0 8px 20px rgba(5, 150, 105, 0.2),
                0 2px 4px rgba(5, 150, 105, 0.1) !important;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
            position: relative;
            overflow: hidden;
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .chart-card:hover {
            transform: translateY(-5px) !important;
            box-shadow: 
                0 20px 40px rgba(5, 150, 105, 0.3),
                0 4px 8px rgba(5, 150, 105, 0.2) !important;
        }

        /* Table Card */
        .table-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border: none !important;
            border-radius: 20px !important;
            box-shadow: 
                0 8px 20px rgba(5, 150, 105, 0.2),
                0 2px 4px rgba(5, 150, 105, 0.1) !important;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
            position: relative;
            overflow: hidden;
        }

        .table-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .empty-state {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 3rem 2rem;
            text-align: center;
            border: 2px dashed #d1d5db;
        }

        .empty-state .fas {
            font-size: 4rem;
            color: #9ca3af;
            margin-bottom: 1.5rem;
        }

        .empty-state h4 {
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        /* Header Section */
        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #020605;
            margin-bottom: 0.5rem;
        }

        .text-muted {
            color: #000309 !important;
            font-size: 1.1rem;
        }

        /* Buttons - Match Other Pages */
        .btn {
            cursor: pointer !important;
            user-select: none;
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            outline: none;
            font-weight: 600;
            border-radius: 15px !important;
            box-shadow: 
                0 8px 20px rgba(1, 18, 13, 0.2),
                0 2px 4px rgba(5, 150, 105, 0.1);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: auto;
            text-decoration: none !important;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 
                0 15px 30px rgba(5, 150, 105, 0.3),
                0 4px 8px rgba(5, 150, 105, 0.2) !important;
            text-decoration: none !important;
        }

        .btn:active {
            transform: translateY(-1px) !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
            border: 2px solid transparent !important;
            padding: 0.875rem 1.5rem !important;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #059669, #047857) !important;
            box-shadow: 
                0 15px 30px rgba(5, 150, 105, 0.4),
                0 4px 8px rgba(5, 150, 105, 0.3) !important;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a) !important;
            color: white !important;
            border: 2px solid transparent !important;
            padding: 0.875rem 1.5rem !important;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #16a34a, #15803d) !important;
            box-shadow: 
                0 15px 30px rgba(22, 163, 74, 0.4),
                0 4px 8px rgba(22, 163, 74, 0.3) !important;
        }

        .btn-outline-primary {
            background: transparent !important;
            color: #059669 !important;
            border: 2px solid #059669 !important;
        }

        .btn-outline-primary:hover {
            background: #059669 !important;
            color: white !important;
        }

        .btn-outline-secondary {
            background: transparent !important;
            color: #6b7280 !important;
            border: 2px solid #6b7280 !important;
        }

        .btn-outline-secondary:hover {
            background: #6b7280 !important;
            color: white !important;
        }

        .btn-outline-danger {
            background: transparent !important;
            color: #dc3545 !important;
            border: 2px solid #dc3545 !important;
        }

        .btn-outline-danger:hover {
            background: #dc3545 !important;
            color: white !important;
        }

        .btn-outline-warning {
            background: transparent !important;
            color: #f59e0b !important;
            border: 2px solid #f59e0b !important;
        }

        .btn-outline-warning:hover {
            background: #f59e0b !important;
            color: white !important;
        }

        .btn-light {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0) !important;
            color: #475569 !important;
            border: 2px solid #e2e8f0 !important;
        }

        .btn-light:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1) !important;
            color: #374151 !important;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem !important;
            font-size: 0.875rem !important;
            border-radius: 10px !important;
        }

        /* Badges */
        .badge-custom {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
        }

        .bg-primary {
            background: linear-gradient(135deg, #10b981, #059669) !important;
        }

        .bg-info {
            background: linear-gradient(135deg, #0ea5e9, #0284c7) !important;
        }

        .bg-success {
            background: linear-gradient(135deg, #22c55e, #16a34a) !important;
        }

        .bg-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }

        .bg-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
        }

        .bg-secondary {
            background: linear-gradient(135deg, #9ca3af, #6b7280) !important;
        }

        .bg-purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important;
        }

        /* Form Controls - Match Other Pages */
        .form-control {
            padding: 0.875rem 1rem !important;
            border: 2px solid #e5e7eb !important;
            border-radius: 10px !important;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-control:focus {
            outline: none !important;
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
            background: rgba(255, 255, 255, 1);
        }

        .form-select {
            padding: 0.875rem 2.5rem 0.875rem 1rem !important;
            border: 2px solid #e5e7eb !important;
            border-radius: 10px !important;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23059669' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 1rem center !important;
            background-size: 16px 12px !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none !important;
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
            background-color: rgba(255, 255, 255, 1) !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23059669' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(16, 185, 129, 0.2) !important;
            border-top: 4px solid #10b981 !important;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert */
        .alert {
            border-radius: 12px !important;
            border: 1px solid transparent !important;
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1) !important;
            color: #065f46 !important;
            border-color: rgba(16, 185, 129, 0.2) !important;
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1) !important;
            color: #991b1b !important;
            border-color: rgba(239, 68, 68, 0.2) !important;
        }

        .alert-info {
            background: rgba(14, 165, 233, 0.1) !important;
            color: #075985 !important;
            border-color: rgba(14, 165, 233, 0.2) !important;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1) !important;
            color: #92400e !important;
            border-color: rgba(245, 158, 11, 0.2) !important;
        }

        /* Card Header */
        .card-header {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
            padding: 1.5rem 2rem !important;
            border: none !important;
            border-radius: 20px 20px 0 0 !important;
        }

        .card-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Table Styling */
        .table {
            margin-bottom: 0;
            background: transparent;
        }

        .table thead th {
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.9);
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            background: rgba(5, 150, 105, 0.05) !important;
            transform: translateY(-1px);
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        /* Category Icons */
        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 1rem;
        }

        /* Modal Styling */
        .modal-content {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border: none !important;
            border-radius: 20px !important;
            box-shadow: 
                0 25px 50px rgba(5, 150, 105, 0.3),
                0 8px 16px rgba(5, 150, 105, 0.2) !important;
        }

        .modal-header {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
            border: none !important;
            border-radius: 20px 20px 0 0 !important;
            padding: 1.5rem 2rem !important;
        }

        .modal-body {
            padding: 2rem !important;
        }

        .modal-footer {
            border: none !important;
            padding: 1.5rem 2rem !important;
            border-radius: 0 0 20px 20px !important;
            background: rgba(255, 255, 255, 0.8) !important;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-legend {
            font-size: 0.8rem;
        }

        .color-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
            margin-right: 8px;
        }

        /* Glow effect */
        .glow {
            position: absolute;
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(5, 150, 105, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(50px);
            z-index: 1;
            animation: glowMove 10s ease-in-out infinite;
        }

        .glow:nth-child(1) {
            top: -80px;
            left: -80px;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.4) 0%, transparent 70%);
        }

        .glow:nth-child(2) {
            bottom: -80px;
            right: -80px;
            animation-delay: -5s;
            background: radial-gradient(circle, rgba(52, 211, 153, 0.3) 0%, transparent 70%);
        }

        @keyframes glowMove {
            0%, 100% { 
                transform: translate(0, 0) scale(1) rotate(0deg); 
            }
            33% { 
                transform: translate(30px, 30px) scale(1.1) rotate(120deg); 
            }
            66% { 
                transform: translate(-20px, 40px) scale(0.9) rotate(240deg); 
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .container {
                max-width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .stats-card h3 {
                font-size: 1.5rem;
            }
            
            .stats-card .fas {
                font-size: 1.5rem;
            }
            
            .navbar-brand {
                font-size: 1.25rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.75rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .form-select, .form-control {
                padding: 0.75rem 2rem 0.75rem 0.75rem !important;
            }
            
            .chart-container {
                height: 200px;
            }
        }

        /* Text selection styles */
        ::selection {
            background: rgba(16, 185, 129, 0.3);
            color: #1f2937;
        }

        ::-moz-selection {
            background: rgba(16, 185, 129, 0.3);
            color: #1f2937;
        }

        /* Animation for expense cards */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .table tbody tr {
            animation: slideIn 0.3s ease forwards;
        }

        .table tbody tr:nth-child(even) {
            animation-delay: 0.1s;
        }

        /* Badge animations */
        .badge {
            transition: all 0.3s ease;
        }

        .badge:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- Add floating particles -->
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>

    <!-- Add glow effects -->
    <div class="glow"></div>
    <div class="glow"></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-money-bill-wave"></i> Expense Tracker
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/homepage.html">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="nav-link" href="/personal-expenses.html">
                    <i class="fas fa-wallet"></i> Personal Expenses
                </a>
                <a class="nav-link" href="/manage-personal-expense.html">
                    <i class="fas fa-cog"></i> Manage Expenses
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Header Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <a href="manage-personal-expense.html" class="btn btn-outline-secondary btn-sm mb-2">
                                <i class="fas fa-arrow-left"></i> Back to Groups
                            </a>
                            <h1><i class="fas fa-folder text-primary"></i> <span id="groupTitle">Loading...</span></h1>
                        </div>
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <p class="text-muted" id="groupDescription">Loading group details...</p>
                    <div class="d-flex flex-wrap gap-2 mb-2" id="groupBadges">
                        <!-- Badges will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Expenses</h6>
                                    <h3 id="totalExpenses">0</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-receipt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Spent</h6>
                                    <h3 id="totalSpent">₹0.00</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Saved</h6>
                                    <h3 id="totalSaved">₹0.00</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-piggy-bank fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Savings %</h6>
                                    <h3 id="savingsPercentage">0%</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Expense by Category</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="categoryChart"></canvas>
                            </div>
                            <div id="categoryLegend" class="chart-legend mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-credit-card"></i> Payment Methods</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="paymentMethodChart"></canvas>
                            </div>
                            <div id="paymentMethodLegend" class="chart-legend mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Expense Button -->
            <div class="row mb-4">
                <div class="col-12">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                        <i class="fas fa-plus-circle me-2"></i>Add New Expense
                    </button>
                </div>
            </div>

            <!-- Expenses List Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card table-card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-receipt"></i> All Expenses</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Date</th>
                                            <th>Payment Method</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expensesList">
                                        <!-- Expenses will be loaded here -->
                                        <tr>
                                            <td colspan="7" class="text-center py-5">
                                                <div class="empty-state">
                                                    <i class="fas fa-receipt fa-4x mb-3"></i>
                                                    <h4>No Expenses Found</h4>
                                                    <p class="mb-3">Loading expenses...</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal fade" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addExpenseModalLabel">Add New Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addExpenseForm">
                        <div class="mb-3">
                            <label for="expenseTitle" class="form-label">Description *</label>
                            <input type="text" class="form-control" id="expenseTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="expenseCategory" class="form-label">Category *</label>
                            <select class="form-select" id="expenseCategory" required>
                                <option value="">Select Category</option>
                                <!-- Essential Categories -->
                                <optgroup label="Essential Expenses">
                                    <option value="HOUSING">Housing</option>
                                    <option value="TRANSPORTATION">Transportation</option>
                                    <option value="FOOD">Food</option>
                                    <option value="UTILITIES">Utilities</option>
                                    <option value="HEALTHCARE">Healthcare</option>
                                    <option value="INSURANCE">Insurance</option>
                                    <option value="SUBSCRIPTIONS">Subscriptions</option>
                                    <option value="PET_CARE">Pet Care</option>
                                    <option value="CHILD_CARE">Child Care</option>
                                    <option value="VEHICLE_MAINTENANCE">Vehicle Maintenance</option>
                                    <option value="HOME_MAINTENANCE">Home Maintenance</option>
                                </optgroup>
                                <!-- Discretionary Categories -->
                                <optgroup label="Lifestyle & Discretionary">
                                    <option value="ENTERTAINMENT">Entertainment</option>
                                    <option value="PERSONAL_CARE">Personal Care</option>
                                    <option value="SHOPPING">Shopping</option>
                                    <option value="TRAVEL">Travel</option>
                                    <option value="DINING_OUT">Dining Out</option>
                                    <option value="GIFTS_DONATIONS">Gifts & Donations</option>
                                </optgroup>
                                <!-- Financial Goals -->
                                <optgroup label="Financial Goals">
                                    <option value="SAVINGS">Savings</option>
                                    <option value="INVESTMENTS">Investments</option>
                                    <option value="DEBT_PAYMENTS">Debt Payments</option>
                                    <option value="EDUCATION">Education</option>
                                </optgroup>
                                <!-- Other -->
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="expenseAmount" class="form-label">Total Spent (₹) *</label>
                            <input type="number" class="form-control" id="expenseAmount" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="expenseSaved" class="form-label">Amount Saved (₹) *</label>
                            <input type="number" class="form-control" id="expenseSaved" min="0" step="0.01" required value="0">
                        </div>
                        <div class="mb-3">
                            <label for="expenseDate" class="form-label">Date *</label>
                            <input type="date" class="form-control" id="expenseDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="expenseNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="expenseNotes" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="expensePaymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="expensePaymentMethod">
                                <option value="">Select Payment Method</option>
                                <option value="CASH">Cash</option>
                                <option value="CREDIT_CARD">Credit Card</option>
                                <option value="DEBIT_CARD">Debit Card</option>
                                <option value="BANK_TRANSFER">Bank Transfer</option>
                                <option value="DIGITAL_WALLET">Digital Wallet</option>
                                <option value="UPI">UPI</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveExpenseBtn">Save Expense</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div class="modal fade" id="editExpenseModal" tabindex="-1" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editExpenseModalLabel">Edit Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editExpenseForm">
                        <input type="hidden" id="editExpenseId">
                        <div class="mb-3">
                            <label for="editExpenseTitle" class="form-label">Description *</label>
                            <input type="text" class="form-control" id="editExpenseTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editExpenseCategory" class="form-label">Category *</label>
                            <select class="form-select" id="editExpenseCategory" required>
                                <option value="">Select Category</option>
                                <!-- Essential Categories -->
                                <optgroup label="Essential Expenses">
                                    <option value="HOUSING">Housing</option>
                                    <option value="TRANSPORTATION">Transportation</option>
                                    <option value="FOOD">Food</option>
                                    <option value="UTILITIES">Utilities</option>
                                    <option value="HEALTHCARE">Healthcare</option>
                                    <option value="INSURANCE">Insurance</option>
                                    <option value="SUBSCRIPTIONS">Subscriptions</option>
                                    <option value="PET_CARE">Pet Care</option>
                                    <option value="CHILD_CARE">Child Care</option>
                                    <option value="VEHICLE_MAINTENANCE">Vehicle Maintenance</option>
                                    <option value="HOME_MAINTENANCE">Home Maintenance</option>
                                </optgroup>
                                <!-- Discretionary Categories -->
                                <optgroup label="Lifestyle & Discretionary">
                                    <option value="ENTERTAINMENT">Entertainment</option>
                                    <option value="PERSONAL_CARE">Personal Care</option>
                                    <option value="SHOPPING">Shopping</option>
                                    <option value="TRAVEL">Travel</option>
                                    <option value="DINING_OUT">Dining Out</option>
                                    <option value="GIFTS_DONATIONS">Gifts & Donations</option>
                                </optgroup>
                                <!-- Financial Goals -->
                                <optgroup label="Financial Goals">
                                    <option value="SAVINGS">Savings</option>
                                    <option value="INVESTMENTS">Investments</option>
                                    <option value="DEBT_PAYMENTS">Debt Payments</option>
                                    <option value="EDUCATION">Education</option>
                                </optgroup>
                                <!-- Other -->
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editExpenseAmount" class="form-label">Total Spent (₹) *</label>
                            <input type="number" class="form-control" id="editExpenseAmount" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="editExpenseSaved" class="form-label">Amount Saved (₹) *</label>
                            <input type="number" class="form-control" id="editExpenseSaved" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="editExpenseDate" class="form-label">Date *</label>
                            <input type="date" class="form-control" id="editExpenseDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editExpenseNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="editExpenseNotes" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editExpensePaymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="editExpensePaymentMethod">
                                <option value="">Select Payment Method</option>
                                <option value="CASH">Cash</option>
                                <option value="CREDIT_CARD">Credit Card</option>
                                <option value="DEBIT_CARD">Debit Card</option>
                                <option value="BANK_TRANSFER">Bank Transfer</option>
                                <option value="DIGITAL_WALLET">Digital Wallet</option>
                                <option value="UPI">UPI</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateExpenseBtn">Update Expense</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
        <div class="loading-spinner" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Global variables
        let currentGroupId = null;
        let expenses = [];
        let currentGroup = null;
        let categoryChart = null;
        let paymentMethodChart = null;

        // Category mapping based on your Java enum
        const categoryData = {
            'HOUSING': { displayName: 'Housing', type: 'ESSENTIAL', icon: 'fas fa-home', color: '#ef4444' },
            'TRANSPORTATION': { displayName: 'Transportation', type: 'ESSENTIAL', icon: 'fas fa-car', color: '#f97316' },
            'FOOD': { displayName: 'Food', type: 'ESSENTIAL', icon: 'fas fa-utensils', color: '#f59e0b' },
            'UTILITIES': { displayName: 'Utilities', type: 'ESSENTIAL', icon: 'fas fa-bolt', color: '#10b981' },
            'HEALTHCARE': { displayName: 'Healthcare', type: 'ESSENTIAL', icon: 'fas fa-heartbeat', color: '#ec4899' },
            'INSURANCE': { displayName: 'Insurance', type: 'ESSENTIAL', icon: 'fas fa-shield-alt', color: '#8b5cf6' },
            'ENTERTAINMENT': { displayName: 'Entertainment', type: 'DISCRETIONARY', icon: 'fas fa-film', color: '#06b6d4' },
            'PERSONAL_CARE': { displayName: 'Personal Care', type: 'DISCRETIONARY', icon: 'fas fa-user', color: '#6b7280' },
            'SHOPPING': { displayName: 'Shopping', type: 'DISCRETIONARY', icon: 'fas fa-shopping-bag', color: '#f97316' },
            'TRAVEL': { displayName: 'Travel', type: 'DISCRETIONARY', icon: 'fas fa-plane', color: '#3b82f6' },
            'DINING_OUT': { displayName: 'Dining Out', type: 'DISCRETIONARY', icon: 'fas fa-utensils', color: '#22c55e' },
            'SAVINGS': { displayName: 'Savings', type: 'FINANCIAL_GOAL', icon: 'fas fa-piggy-bank', color: '#10b981' },
            'INVESTMENTS': { displayName: 'Investments', type: 'FINANCIAL_GOAL', icon: 'fas fa-chart-line', color: '#06b6d4' },
            'EDUCATION': { displayName: 'Education', type: 'INVESTMENT', icon: 'fas fa-graduation-cap', color: '#8b5cf6' },
            'DEBT_PAYMENTS': { displayName: 'Debt Payments', type: 'FINANCIAL_GOAL', icon: 'fas fa-credit-card', color: '#ef4444' },
            'GIFTS_DONATIONS': { displayName: 'Gifts & Donations', type: 'DISCRETIONARY', icon: 'fas fa-gift', color: '#ec4899' },
            'SUBSCRIPTIONS': { displayName: 'Subscriptions', type: 'ESSENTIAL', icon: 'fas fa-newspaper', color: '#6b7280' },
            'PET_CARE': { displayName: 'Pet Care', type: 'ESSENTIAL', icon: 'fas fa-paw', color: '#f97316' },
            'CHILD_CARE': { displayName: 'Child Care', type: 'ESSENTIAL', icon: 'fas fa-baby', color: '#f59e0b' },
            'VEHICLE_MAINTENANCE': { displayName: 'Vehicle Maintenance', type: 'ESSENTIAL', icon: 'fas fa-tools', color: '#06b6d4' },
            'HOME_MAINTENANCE': { displayName: 'Home Maintenance', type: 'ESSENTIAL', icon: 'fas fa-hammer', color: '#22c55e' },
            'OTHER': { displayName: 'Other', type: 'OTHER', icon: 'fas fa-question-circle', color: '#6b7280' }
        };

        // Payment method colors
        const paymentMethodColors = {
            'CASH': '#22c55e',
            'CREDIT_CARD': '#ef4444',
            'DEBIT_CARD': '#3b82f6',
            'BANK_TRANSFER': '#8b5cf6',
            'DIGITAL_WALLET': '#f97316',
            'UPI': '#10b981',
            'OTHER': '#6b7280'
        };

        // Payment method display names
        const paymentMethodDisplayNames = {
            'CASH': 'Cash',
            'CREDIT_CARD': 'Credit Card',
            'DEBIT_CARD': 'Debit Card',
            'BANK_TRANSFER': 'Bank Transfer',
            'DIGITAL_WALLET': 'Digital Wallet',
            'UPI': 'UPI',
            'OTHER': 'Other'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('saveExpenseBtn').addEventListener('click', saveExpense);
            document.getElementById('updateExpenseBtn').addEventListener('click', updateExpense);
            
            // Set today's date as default for the expense form
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            document.getElementById('editExpenseDate').value = today;
            
            checkAuthAndLoadData();
        });

        // --- AUTHENTICATION FUNCTIONS ---
        function decodeJwtToken(token) {
            if (!token) return null;
            try {
                const payload = token.split('.')[1];
                const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
                return JSON.parse(decoded);
            } catch {
                return null;
            }
        }

        function isTokenExpired(token) {
            try {
                const payload = decodeJwtToken(token);
                if (!payload || !payload.exp) return true;

                const expiry = payload.exp * 1000;
                const now = Date.now();
                return now >= expiry;
            } catch {
                return true;
            }
        }

        function checkAuthAndRedirect() {
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                console.log("No JWT token found. Redirecting to login...");
                window.location.href = 'login.html';
                return false;
            }

            if (isTokenExpired(token)) {
                console.log("JWT token expired. Redirecting to login...");
                localStorage.removeItem('jwtToken');
                window.location.href = 'login.html';
                return false;
            }

            return true;
        }

        // --- ENCRYPTION/DECRYPTION FUNCTIONS ---
        function encodeGroupId(groupId) {
            // Simple base64 encoding to hide the group ID from casual users
            return btoa(groupId.toString()).replace(/=/g, '');
        }

        function decodeGroupId(encodedId) {
            try {
                // Add padding if needed and decode
                let padded = encodedId;
                while (padded.length % 4 !== 0) {
                    padded += '=';
                }
                return atob(padded);
            } catch (error) {
                console.error('Error decoding group ID:', error);
                return null;
            }
        }

        // --- DATA LOADING FUNCTIONS ---
        async function checkAuthAndLoadData() {
            if (!checkAuthAndRedirect()) {
                return;
            }

            showLoading(true);
            try {
                await loadGroupDetails();
                await loadExpenses();
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Failed to load data. Please try again.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function loadGroupDetails() {
            try {
                // Extract and decode group ID from URL
                currentGroupId = getGroupIdFromUrl();
                if (!currentGroupId) {
                    throw new Error('Group ID not found in URL');
                }

                const token = localStorage.getItem('jwtToken');
                const response = await axios.get(`/api/expense-groups/${currentGroupId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Handle both direct data and ApiResponse format
                currentGroup = response.data.data || response.data;
                updateGroupUI(currentGroup);
                
            } catch (error) {
                console.error('Error loading group details:', error);
                if (error.response && error.response.status === 401) {
                    showAlert('Authentication failed. Please login again.', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                }
                throw error;
            }
        }

        function getGroupIdFromUrl() {
            // Extract encoded group ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const encodedId = urlParams.get('id');
            
            if (encodedId) {
                const decodedId = decodeGroupId(encodedId);
                if (decodedId) {
                    return decodedId;
                }
            }
            
            // Fallback: Try to extract from filename (for backward compatibility)
            const path = window.location.pathname;
            const filename = path.split('/').pop();
            
            if (filename.startsWith('group-details-')) {
                return filename.replace('group-details-', '').replace('.html', '');
            }
            
            // For demo purposes, return default ID
            console.warn('No valid group ID found in URL, using default');
            return '1';
        }

        function updateGroupUI(group) {
            document.title = `${group.title} Expenses - Expense Tracker`;
            document.getElementById('groupTitle').textContent = group.title;
            document.getElementById('groupDescription').textContent = group.description || 'No description provided';
            
            // Update badges
            const badgesContainer = document.getElementById('groupBadges');
            badgesContainer.innerHTML = `
                <span class="badge bg-primary badge-custom">
                    <i class="fas fa-calendar me-1"></i>
                    ${formatDate(group.fromDate)} - ${formatDate(group.toDate)}
                </span>
                <span class="badge bg-info badge-custom">
                    <i class="fas fa-receipt me-1"></i>
                    ${group.expenseCount || 0} expenses
                </span>
                <span class="badge bg-success badge-custom">
                    <i class="fas fa-money-bill me-1"></i>
                    ₹${(group.totalSpentInGroup || 0).toFixed(2)}
                </span>
            `;
            
            // Update statistics
            document.getElementById('totalExpenses').textContent = group.expenseCount || 0;
            document.getElementById('totalSpent').textContent = '₹' + (group.totalSpentInGroup || 0).toFixed(2);
            document.getElementById('totalSaved').textContent = '₹' + (group.totalSavedInGroup || 0).toFixed(2);
            document.getElementById('savingsPercentage').textContent = (group.groupSavingsPercentage || 0).toFixed(1) + '%';
        }

        async function loadExpenses() {
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await axios.get(`/api/expenses/group/${currentGroupId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Handle both direct data and ApiResponse format
                expenses = response.data.data || response.data || [];
                displayExpenses(expenses);
                updateCharts(expenses);
            } catch (error) {
                console.error('Error loading expenses:', error);
                if (error.response && error.response.status === 401) {
                    showAlert('Authentication failed. Please login again.', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } else {
                    showAlert('Failed to load expenses.', 'danger');
                }
            }
        }

        // --- CHART FUNCTIONS ---
        function updateCharts(expenses) {
            updateCategoryChart(expenses);
            updatePaymentMethodChart(expenses);
        }

        function updateCategoryChart(expenses) {
            const categoryTotals = {};
            
            // Calculate total spent per category
            expenses.forEach(expense => {
                const category = expense.category;
                const amount = expense.totalSpent || 0;
                
                if (categoryTotals[category]) {
                    categoryTotals[category] += amount;
                } else {
                    categoryTotals[category] = amount;
                }
            });

            // Prepare chart data
            const labels = [];
            const data = [];
            const backgroundColors = [];
            const hoverBackgroundColors = [];

            Object.keys(categoryTotals).forEach(category => {
                const categoryInfo = categoryData[category] || categoryData['OTHER'];
                labels.push(categoryInfo.displayName);
                data.push(categoryTotals[category]);
                backgroundColors.push(categoryInfo.color);
                hoverBackgroundColors.push(adjustColor(categoryInfo.color, -20));
            });

            // Get or create chart context
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (categoryChart) {
                categoryChart.destroy();
            }

            // Create new chart
            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverBackgroundColor: hoverBackgroundColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ₹${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Update legend
            updateCategoryLegend(labels, data, backgroundColors);
        }

        function updatePaymentMethodChart(expenses) {
            const paymentMethodTotals = {};
            const paymentMethodCounts = {};
            
            // Calculate total spent and count per payment method
            expenses.forEach(expense => {
                const paymentMethod = expense.paymentMethod || 'OTHER';
                const amount = expense.totalSpent || 0;
                
                if (paymentMethodTotals[paymentMethod]) {
                    paymentMethodTotals[paymentMethod] += amount;
                    paymentMethodCounts[paymentMethod] += 1;
                } else {
                    paymentMethodTotals[paymentMethod] = amount;
                    paymentMethodCounts[paymentMethod] = 1;
                }
            });

            // Prepare chart data
            const labels = [];
            const data = [];
            const backgroundColors = [];
            const hoverBackgroundColors = [];

            Object.keys(paymentMethodTotals).forEach(paymentMethod => {
                const displayName = paymentMethodDisplayNames[paymentMethod] || 'Other';
                const count = paymentMethodCounts[paymentMethod] || 0;
                labels.push(`${displayName} (${count})`);
                data.push(paymentMethodTotals[paymentMethod]);
                backgroundColors.push(paymentMethodColors[paymentMethod] || paymentMethodColors['OTHER']);
                hoverBackgroundColors.push(adjustColor(paymentMethodColors[paymentMethod] || paymentMethodColors['OTHER'], -20));
            });

            // Get or create chart context
            const ctx = document.getElementById('paymentMethodChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (paymentMethodChart) {
                paymentMethodChart.destroy();
            }

            // Create new chart
            paymentMethodChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverBackgroundColor: hoverBackgroundColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label.split(' (')[0]; // Remove count from label
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ₹${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Update legend
            updatePaymentMethodLegend(labels, data, backgroundColors);
        }

        function updateCategoryLegend(labels, data, colors) {
            const total = data.reduce((a, b) => a + b, 0);
            const legendContainer = document.getElementById('categoryLegend');
            
            let legendHTML = '<div class="row">';
            
            labels.forEach((label, index) => {
                const value = data[index];
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                const color = colors[index];
                
                legendHTML += `
                    <div class="col-md-6 mb-2">
                        <div class="d-flex align-items-center">
                            <div class="color-box me-2" style="background-color: ${color};"></div>
                            <small class="text-truncate">
                                <strong>${label}</strong><br>
                                <span class="text-muted">₹${value.toFixed(2)} (${percentage}%)</span>
                            </small>
                        </div>
                    </div>
                `;
            });
            
            legendHTML += '</div>';
            legendContainer.innerHTML = legendHTML;
        }

        function updatePaymentMethodLegend(labels, data, colors) {
            const total = data.reduce((a, b) => a + b, 0);
            const legendContainer = document.getElementById('paymentMethodLegend');
            
            let legendHTML = '<div class="row">';
            
            labels.forEach((label, index) => {
                const value = data[index];
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                const color = colors[index];
                
                legendHTML += `
                    <div class="col-md-6 mb-2">
                        <div class="d-flex align-items-center">
                            <div class="color-box me-2" style="background-color: ${color};"></div>
                            <small class="text-truncate">
                                <strong>${label.split(' (')[0]}</strong><br>
                                <span class="text-muted">₹${value.toFixed(2)} (${percentage}%)</span>
                            </small>
                        </div>
                    </div>
                `;
            });
            
            legendHTML += '</div>';
            legendContainer.innerHTML = legendHTML;
        }

        function adjustColor(color, amount) {
            // Simple color adjustment for hover effects
            return '#' + color.replace(/^#/, '').replace(/../g, color => 
                ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2)
            );
        }

        // --- DISPLAY FUNCTIONS ---
        function displayExpenses(expenses) {
            const container = document.getElementById('expensesList');
            
            if (!expenses || expenses.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="empty-state">
                                <i class="fas fa-receipt fa-4x mb-3"></i>
                                <h4>No Expenses Found</h4>
                                <p class="mb-3">You haven't added any expenses to this group yet.</p>
                                <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                                    <i class="fas fa-plus-circle me-2"></i>Add Your First Expense
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            container.innerHTML = expenses.map(expense => {
                const category = categoryData[expense.category] || categoryData['OTHER'];
                const paymentMethod = expense.paymentMethod ? paymentMethodDisplayNames[expense.paymentMethod] : 'Not specified';
                
                return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="category-icon">
                                <i class="${category.icon}"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${expense.title}</div>
                                <small class="text-muted">${expense.description || ''}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getCategoryBadgeClass(expense.category)} badge-custom">
                            ${category.displayName}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${getTypeBadgeClass(category.type)} badge-custom">
                            ${getTypeDisplayName(category.type)}
                        </span>
                    </td>
                    <td class="fw-bold text-success">₹${expense.totalSpent.toFixed(2)}</td>
                    <td>${formatDate(expense.expenseDate)}</td>
                    <td>
                        <span class="badge bg-secondary badge-custom">${paymentMethod}</span>
                    </td>
                    <td>
                        <button class="btn btn-outline-warning btn-sm me-1" onclick="editExpense(${expense.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteExpense(${expense.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // --- UTILITY FUNCTIONS ---
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function getCategoryBadgeClass(category) {
            const categoryInfo = categoryData[category] || categoryData['OTHER'];
            switch(categoryInfo.type) {
                case 'ESSENTIAL': return 'bg-danger';
                case 'DISCRETIONARY': return 'bg-primary';
                case 'FINANCIAL_GOAL': return 'bg-success';
                case 'INVESTMENT': return 'bg-purple';
                default: return 'bg-secondary';
            }
        }

        function getTypeBadgeClass(type) {
            switch(type) {
                case 'ESSENTIAL': return 'bg-danger';
                case 'DISCRETIONARY': return 'bg-primary';
                case 'FINANCIAL_GOAL': return 'bg-success';
                case 'INVESTMENT': return 'bg-purple';
                default: return 'bg-secondary';
            }
        }

        function getTypeDisplayName(type) {
            switch(type) {
                case 'ESSENTIAL': return 'Essential';
                case 'DISCRETIONARY': return 'Lifestyle';
                case 'FINANCIAL_GOAL': return 'Financial';
                case 'INVESTMENT': return 'Investment';
                default: return 'Other';
            }
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type) {
            // Remove any existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // --- EXPENSE ACTION FUNCTIONS ---
        async function saveExpense() {
            try {
                // Validate form
                const form = document.getElementById('addExpenseForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                showLoading(true);
                
                const token = localStorage.getItem('jwtToken');
                const expenseData = {
                    title: document.getElementById('expenseTitle').value,
                    description: document.getElementById('expenseNotes').value,
                    category: document.getElementById('expenseCategory').value,
                    totalSpent: parseFloat(document.getElementById('expenseAmount').value),
                    amountSaved: parseFloat(document.getElementById('expenseSaved').value),
                    expenseDate: document.getElementById('expenseDate').value + 'T00:00:00Z', // Convert to ISO format
                    paymentMethod: document.getElementById('expensePaymentMethod').value || null,
                    expenseGroupId: parseInt(currentGroupId)
                };

                console.log('Saving expense:', expenseData);

                const response = await axios.post('/api/expenses', expenseData, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // Close modal and refresh data
                const modal = bootstrap.Modal.getInstance(document.getElementById('addExpenseModal'));
                modal.hide();
                document.getElementById('addExpenseForm').reset();
                
                showAlert('Expense added successfully!', 'success');
                await refreshData();
                
            } catch (error) {
                console.error('Error saving expense:', error);
                let errorMessage = 'Failed to add expense. Please try again.';
                
                if (error.response) {
                    console.error('Server response:', error.response.data);
                    errorMessage = error.response.data.message || errorMessage;
                    
                    // Handle authentication errors
                    if (error.response.status === 401) {
                        errorMessage = 'Authentication failed. Please login again.';
                        showAlert(errorMessage, 'danger');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                }
                
                showAlert(errorMessage, 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function editExpense(expenseId) {
            try {
                showLoading(true);
                
                const token = localStorage.getItem('jwtToken');
                const response = await axios.get(`/api/expenses/${expenseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Handle both direct data and ApiResponse format
                const expense = response.data.data || response.data;
                
                // Populate edit form
                document.getElementById('editExpenseId').value = expense.id;
                document.getElementById('editExpenseTitle').value = expense.title;
                document.getElementById('editExpenseCategory').value = expense.category;
                document.getElementById('editExpenseAmount').value = expense.totalSpent;
                document.getElementById('editExpenseSaved').value = expense.amountSaved;
                document.getElementById('editExpenseDate').value = expense.expenseDate.split('T')[0];
                document.getElementById('editExpenseNotes').value = expense.description || '';
                document.getElementById('editExpensePaymentMethod').value = expense.paymentMethod || '';

                // Show edit modal
                const modal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading expense for edit:', error);
                if (error.response && error.response.status === 401) {
                    showAlert('Authentication failed. Please login again.', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } else {
                    showAlert('Failed to load expense for editing.', 'danger');
                }
            } finally {
                showLoading(false);
            }
        }

        async function updateExpense() {
            try {
                // Validate form
                const form = document.getElementById('editExpenseForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                showLoading(true);
                
                const token = localStorage.getItem('jwtToken');
                const expenseId = document.getElementById('editExpenseId').value;
                const expenseData = {
                    title: document.getElementById('editExpenseTitle').value,
                    description: document.getElementById('editExpenseNotes').value,
                    category: document.getElementById('editExpenseCategory').value,
                    totalSpent: parseFloat(document.getElementById('editExpenseAmount').value),
                    amountSaved: parseFloat(document.getElementById('editExpenseSaved').value),
                    expenseDate: document.getElementById('editExpenseDate').value + 'T00:00:00Z', // Convert to ISO format
                    paymentMethod: document.getElementById('editExpensePaymentMethod').value || null,
                    expenseGroupId: parseInt(currentGroupId)
                };

                console.log('Updating expense:', expenseData);

                await axios.put(`/api/expenses/${expenseId}`, expenseData, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // Close modal and refresh data
                const modal = bootstrap.Modal.getInstance(document.getElementById('editExpenseModal'));
                modal.hide();
                
                showAlert('Expense updated successfully!', 'success');
                await refreshData();
                
            } catch (error) {
                console.error('Error updating expense:', error);
                let errorMessage = 'Failed to update expense. Please try again.';
                
                if (error.response) {
                    console.error('Server response:', error.response.data);
                    errorMessage = error.response.data.message || errorMessage;
                    
                    // Handle authentication errors
                    if (error.response.status === 401) {
                        errorMessage = 'Authentication failed. Please login again.';
                        showAlert(errorMessage, 'danger');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                }
                
                showAlert(errorMessage, 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) {
                return;
            }

            try {
                showLoading(true);
                
                const token = localStorage.getItem('jwtToken');
                await axios.delete(`/api/expenses/${expenseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                showAlert('Expense deleted successfully!', 'success');
                await refreshData();
            } catch (error) {
                console.error('Error deleting expense:', error);
                if (error.response && error.response.status === 401) {
                    showAlert('Authentication failed. Please login again.', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } else {
                    showAlert('Failed to delete expense.', 'danger');
                }
            } finally {
                showLoading(false);
            }
        }

        async function refreshData() {
            await checkAuthAndLoadData();
        }

        // Add enter key support for forms
        document.getElementById('addExpenseForm')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveExpense();
            }
        });

        document.getElementById('editExpenseForm')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                updateExpense();
            }
        });
    </script>
</body>
</html>